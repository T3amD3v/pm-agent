<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Project Task Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Font & basic reset -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f14;
      --card: #0f1520;
      --muted: #94a3b8;
      --text: #e6edf5;
      --accent: #4f46e5;   /* indigo */
      --accent-2: #06b6d4; /* cyan */
      --ring: rgba(79,70,229,.45);
      --border: rgba(148,163,184,.15);
      --success: #16a34a;
      --danger: #dc2626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 10% -20%, rgba(79,70,229,.25), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(6,182,212,.2), transparent 60%),
        var(--bg);
      display:grid;
      place-items:center;
      padding:24px;
    }
    .shell{
      width:100%;
      max-width:900px;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)) , var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      overflow:hidden;
    }
    .header{
      padding:28px 28px 0 28px;
    }
    .title{
      font-size:1.5rem;
      font-weight:700;
      letter-spacing:.2px;
      margin:0 0 6px;
    }
    .subtitle{
      margin:0 0 18px;
      color:var(--muted);
      font-size:.95rem;
    }
    form{
      padding:0 28px 28px 28px;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:18px;
    }
    @media (min-width: 820px){
      .grid{
        grid-template-columns: 1fr 1fr;
      }
      .grid .full{
        grid-column: 1 / -1;
      }
    }

    label{
      display:block;
      font-weight:600;
      margin:0 0 8px;
    }
    .help{
      display:block;
      color:var(--muted);
      font-weight:500;
      font-size:.85rem;
      margin-top:6px;
    }
    .field{
      position:relative;
    }
    input[type="text"],
    textarea{
      width:100%;
      background:#0c111a;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      font-size:1rem;
      outline:none;
      transition:border .2s, box-shadow .2s, transform .02s;
    }
    textarea{ resize: vertical; min-height:120px }

    input[type="text"]:focus,
    textarea:focus{
      border-color:var(--ring);
      box-shadow:0 0 0 6px rgba(79,70,229,.15);
    }

    /* File dropzone */
    .drop{
      border:1px dashed var(--border);
      background:#0c111a;
      border-radius:12px;
      padding:18px;
      display:flex;
      align-items:center;
      gap:14px;
      transition:border-color .2s, background .2s;
      cursor:pointer;
      min-height:84px;
    }
    .drop:hover{
      border-color:var(--ring);
      background:rgba(79,70,229,.04);
    }
    .drop.dragover{
      border-color:var(--accent);
      background:rgba(79,70,229,.08);
      box-shadow:0 0 0 6px rgba(79,70,229,.15) inset;
    }
    .drop .icon{
      width:42px; height:42px; border-radius:10px;
      display:grid; place-items:center;
      background:linear-gradient(135deg, rgba(79,70,229,.35), rgba(6,182,212,.35));
    }
    .drop .copy{
      flex:1;
    }
    .drop .copy b{ color:#fff }
    .file-list{
      margin-top:10px;
      padding-left:0;
      list-style:none;
      display:grid; gap:6px;
      font-size:.92rem;
    }
    .file-pill{
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      padding:8px 10px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      width:fit-content;
    }

    /* Buttons */
    .actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:10px;
    }
    button{
      appearance:none;
      border:none;
      border-radius:12px;
      padding:12px 16px;
      font-weight:600;
      font-size:1rem;
      cursor:pointer;
      transition:transform .02s, filter .2s, box-shadow .2s, opacity .2s;
    }
    button:active{ transform:translateY(1px) }
    .btn-primary{
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      color:white;
      box-shadow:0 8px 24px rgba(79,70,229,.35);
    }
    .btn-primary[disabled]{ opacity:.65; cursor:not-allowed; filter:saturate(.5) }

    /* Footer note / toasts */
    .footer{
      border-top:1px solid var(--border);
      padding:14px 20px;
      color:var(--muted);
      font-size:.85rem;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,0));
    }
    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      background:#0c111a;
      border:1px solid var(--border);
      color:var(--text);
      padding:12px 14px;
      border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
      display:none;
    }
    .toast.show{ display:block }
    .toast.success{ border-color:rgba(22,163,74,.35) }
    .toast.error{ border-color:rgba(220,38,38,.35) }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="header">
        <h1 class="title">Project Task Generator</h1>
        <p class="subtitle">Drop your files, describe the project, and Iâ€™ll ping the webhook to build your task list.</p>
      </div>

      <form id="projectForm">
        <div class="grid">
          <div class="field full">
            <label for="projectName">Project Name</label>
            <input type="text" id="projectName" required placeholder="e.g., Marketing Site Revamp" />
          </div>

          <div class="field full">
            <label for="projectDescription">Project Description</label>
            <textarea id="projectDescription" rows="6" required placeholder="What are we building? Scope, goals, target usersâ€¦"></textarea>
            <small class="help">Give enough context for quality tasks.</small>
          </div>

          <div class="field full">
            <label for="files">Upload Project Files</label>

            <!-- Fancy drop zone (the actual input#files is still present + untouched) -->
            <div id="dropzone" class="drop" tabindex="0" role="button" aria-controls="files" aria-label="Upload files">
              <div class="icon">ðŸ“Ž</div>
              <div class="copy">
                <div><b>Drag & drop</b> your files here, or click to browse.</div>
                <small class="help">You can add multiple files. PDFs, docs, images, whatever.</small>
              </div>
            </div>

            <!-- Keep the original input with the same id (used by your webhook logic) -->
            <input type="file" id="files" multiple style="position:absolute; width:1px; height:1px; opacity:0; pointer-events:none;" />
            <ul id="fileList" class="file-list"></ul>
          </div>

          <div class="field full">
            <label for="requirements">Specific Requirements / Context</label>
            <textarea id="requirements" rows="4" placeholder="Constraints, dependencies, tech stack, deadlines, etc."></textarea>
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn-primary" id="submitBtn">
            <span id="btnText">Generate Task List</span>
            <span id="btnSpinner" style="display:none"> â€¢ â€¢ â€¢ </span>
          </button>
        </div>
      </form>

      <div class="footer">
        <span>Pro tip: bigger files may take a sec to encode before sending.</span>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Message</div>

  <script>
    // ---------- UI sugar: dropzone wiring (input#files is UNCHANGED) ----------
    const dz = document.getElementById('dropzone');
    const fileInput = document.getElementById('files');
    const fileList = document.getElementById('fileList');

    const openPicker = () => fileInput.click();
    dz.addEventListener('click', openPicker);
    dz.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openPicker(); }
    });

    const renderFiles = () => {
      fileList.innerHTML = '';
      const files = fileInput.files;
      for (let i = 0; i < files.length; i++) {
        const li = document.createElement('li');
        li.className = 'file-pill';
        li.textContent = `${files[i].name} (${Math.ceil(files[i].size / 1024)} KB)`;
        fileList.appendChild(li);
      }
    };

    fileInput.addEventListener('change', renderFiles);

    const stop = (e) => { e.preventDefault(); e.stopPropagation(); };
    ['dragenter','dragover','dragleave','drop'].forEach(evt => {
      dz.addEventListener(evt, stop);
      document.body.addEventListener(evt, stop);
    });
    ['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, () => dz.classList.add('dragover')));
    ['dragleave','drop'].forEach(evt => dz.addEventListener(evt, () => dz.classList.remove('dragover')));

    dz.addEventListener('drop', (e) => {
      const items = e.dataTransfer.files;
      if (!items || !items.length) return;
      // Merge dropped files with existing selection
      const dt = new DataTransfer();
      // keep current ones
      for (const f of fileInput.files) dt.items.add(f);
      // add new
      for (const f of items) dt.items.add(f);
      fileInput.files = dt.files;
      renderFiles();
    });

    // ---------- Toast helpers ----------
    const toast = document.getElementById('toast');
    function showToast(msg, type=''){
      toast.textContent = msg;
      toast.className = 'toast show ' + (type || '');
      setTimeout(() => { toast.className = 'toast ' + (type || ''); }, 2800);
    }

    // ---------- Submit button state ----------
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    function setSubmitting(isOn){
      submitBtn.disabled = isOn;
      btnText.style.display = isOn ? 'none' : 'inline';
      btnSpinner.style.display = isOn ? 'inline' : 'none';
    }

    // ---------- YOUR ORIGINAL LOGIC (webhook untouched) ----------
    document.getElementById('projectForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      setSubmitting(true);

      const formData = new FormData();

      // CRITICAL: Add these text fields - they're missing in your current submission!
      formData.append('projectName', document.getElementById('projectName').value);
      formData.append('projectDescription', document.getElementById('projectDescription').value);
      formData.append('requirements', document.getElementById('requirements').value || '');

      // Add files with consistent indexing starting from 1
      const files = document.getElementById('files').files;
      for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const base64 = await convertToBase64(file);
          formData.append(`file_${i + 1}`, base64);  // Start from 1, not 0
          formData.append(`filename_${i + 1}`, file.name);  // Start from 1, not 0
      }
      formData.append('fileCount', files.length.toString());

      // Your webhook URL
      formData.append('webhookUrl', 'https://trybl.app.n8n.cloud/webhook-test/project-tasks');
      formData.append('executionMode', 'test');

      // Send to n8n webhook
      try {
          const response = await fetch('https://trybl.app.n8n.cloud/webhook-test/project-tasks', {
              method: 'POST',
              body: formData
          });

          // If n8n returns non-JSON or no body, this won't explode the UI
          let result = null;
          try { result = await response.json(); } catch(_) {}

          showToast('Tasks generated successfully!', 'success');
      } catch (error) {
          showToast('Error: ' + error.message, 'error');
      } finally {
          setSubmitting(false);
      }
    });

    function convertToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
  </script>
</body>
</html>
